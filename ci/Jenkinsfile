pipeline { 
    agent { dockerfile true }
    options {
        skipStagesAfterUnstable()
    }
    stages {
        stage('Run test') { 
            when {
                anyOf {
                    changeRequest() 
                    branch 'develop'
                    branch 'master'  
                }
            }
            steps { 
                sh label: 'Populate dotenv for tests', script: '''cat <<EOF > .env
                    # Entrypoint HTTP Server
                    NODE_ENV=development 
                    ENTRYPOINT_HTTP_PORT=12000

                    ENTRYPOINT_GRPC_PORT=3333

                    MONGO_PRIMARY_URI=mongodb://localhost:27017/mydb
                    MONGO_REPLICA_URI=mongodb://localhost:27017/mydb

                    KAFKA_HOST=localhost:9092
                    KAFKA_CONNECT_TIMEOUT=1000
                    TODO_TOPIC=todo_topic
                EOF'''
                sh label: 'Run tests', script: '''
                                        npm install
                                        npm run test-coverage
                                        '''
            }
        }
    }
}